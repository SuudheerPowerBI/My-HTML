WITH RACK_LEVELS AS (
    SELECT
        B.DC_ID,
        B.WHSE_ID,
        B.LOC_ID,
        SUBSTR(B.LOC_ID, 1, 3) AS LOC_PREFIX,
        B.X_COORD,
        B.Y_COORD,
        B.Z_COORD,
        B.LEV AS ORIGINAL_LEV,
        B.LDES_ID,
        ROW_NUMBER() OVER (
            PARTITION BY B.DC_ID, B.WHSE_ID,
                         SUBSTR(B.LOC_ID, 1, 3),
                         B.X_COORD, B.Y_COORD
            ORDER BY B.Z_COORD ASC
        ) AS CALC_LEVEL
    FROM CORE_FSSC.CURATED_LOGISTICS.ILOC B
    JOIN CORE_FSSC.CURATED_LOGISTICS.IPLAS A
        ON B.LOC_ID = A.LOC_ID
        AND B.DC_ID = A.DC_ID
        AND B.WHSE_ID = A.WHSE_ID
    WHERE A.LCUS_ID = 'P'
      AND B.LDES_ID IN ('FW', 'SF')
      AND B.DC_ID NOT IN (7, 22)
)

SELECT
    DC_ID,
    WHSE_ID,
    LOC_ID,
    LOC_PREFIX,
    X_COORD,
    Y_COORD,
    Z_COORD,
    ORIGINAL_LEV,
    CALC_LEVEL,
    LDES_ID,
    CASE
        WHEN ORIGINAL_LEV = CALC_LEVEL THEN 'MATCH'
        WHEN ORIGINAL_LEV IS NULL OR ORIGINAL_LEV = 0 THEN 'LEV MISSING'
        ELSE 'MISMATCH'
    END AS LEV_STATUS
FROM RACK_LEVELS
ORDER BY DC_ID, LOC_PREFIX, X_COORD, Y_COORD, Z_COORD
