WITH COMPARE AS (
    SELECT
        A.DC_ID,
        A.LOC_ID AS PICK_SLOT,
        B.LDES_ID,
        B.LEV,
        B.Z_COORD AS Z1,
        B.SEL_POS_HGT,
        (SELECT MIN(C.Z_COORD)
         FROM CORE_FSSC.CURATED_LOGISTICS.ILOC C
         WHERE C.X_COORD = B.X_COORD
           AND C.Y_COORD = B.Y_COORD
           AND C.DC_ID = B.DC_ID
           AND C.WHSE_ID = B.WHSE_ID
           AND C.LEV = B.LEV + 1
           AND SUBSTR(C.LOC_ID, 1, 3) = SUBSTR(A.LOC_ID, 1, 3)
        ) AS Z2
    FROM CORE_FSSC.CURATED_LOGISTICS.IPLAS A
    JOIN CORE_FSSC.CURATED_LOGISTICS.ILOC B 
        ON A.LOC_ID = B.LOC_ID 
        AND A.DC_ID = B.DC_ID 
        AND A.WHSE_ID = B.WHSE_ID
    WHERE A.LCUS_ID = 'P'
      AND B.LDES_ID IN ('FW', 'SF')
      AND A.DC_ID NOT IN (7, 22)
)

SELECT
    DC_ID,
    PICK_SLOT,
    LDES_ID,
    LEV,
    Z1,
    Z2,
    SEL_POS_HGT,
    Z2 - Z1 AS Z_DIFF_RAW,
    CASE 
        WHEN LDES_ID = 'FW' THEN Z2 - Z1 - 6
        ELSE Z2 - Z1 - 2
    END AS Z_CALC_OPENING,
    SEL_POS_HGT - CASE 
        WHEN LDES_ID = 'FW' THEN Z2 - Z1 - 6
        ELSE Z2 - Z1 - 2
    END AS DIFF,
    CASE
        WHEN Z2 IS NULL THEN 'Z2 MISSING'
        WHEN SEL_POS_HGT = Z2 - Z1 THEN 'SEL = Z_DIFF_RAW'
        WHEN SEL_POS_HGT = (Z2 - Z1 - 6) AND LDES_ID = 'FW' THEN 'SEL = OPENING (FW)'
        WHEN SEL_POS_HGT = (Z2 - Z1 - 2) AND LDES_ID = 'SF' THEN 'SEL = OPENING (SF)'
        ELSE 'NO MATCH'
    END AS MATCH_TYPE
FROM COMPARE
WHERE Z2 IS NOT NULL
ORDER BY DC_ID, PICK_SLOT
